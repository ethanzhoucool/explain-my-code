<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Explanation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Code Explanation</h1>
        
        <div class="header-row">
            <span class="level-badge">{{ level|replace('_', ' ')|title }}</span>
            <div class="mode-toggle-group">
                <button type="button" class="mode-toggle-btn {% if mode != 'ai' %}active{% endif %}" id="ruleBtn">Basic</button>
                <button type="button" class="mode-toggle-btn {% if mode == 'ai' %}active{% endif %}" id="aiBtn">AI</button>
            </div>
        </div>
        
        <h2>{{ language|title }} Code</h2>
        <p class="instruction" id="instruction">{% if mode == 'ai' %}Hover over each line for AI-generated explanations{% else %}Hover over highlighted keywords for explanations{% endif %}</p>
        
        <!-- Rule-based content -->
        <div id="rule-content" style="{% if mode == 'ai' %}display:none;{% endif %}">
            <div class="code-container">
                {% for line in rule_annotated_lines %}
                <div class="code-line">
                    <div class="line-number">{{ line.number }}</div>
                    <div class="line-content">{{ line.highlighted|safe }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- AI content (shown or cached) -->
        <div id="ai-content" style="{% if mode != 'ai' %}display:none;{% endif %}">
            {% if mode == 'ai' %}
            <div class="code-container">
                {% for line in annotated_lines %}
                <div class="code-line">
                    <div class="line-number">{{ line.number }}</div>
                    <div class="line-content">{{ line.highlighted|safe }}</div>
                </div>
                {% endfor %}
            </div>
            {% if ai_explanation %}
            <h2>Summary</h2>
            <div class="ai-explanation-box" id="ai-summary">
                {{ ai_explanation }}
            </div>
            {% endif %}
            {% endif %}
        </div>
        
        <!-- Hidden form for AI request -->
        <form id="aiForm" method="POST" action="/explain" style="display:none;">
            <input type="hidden" name="code" value="{{ code }}">
            <input type="hidden" name="language" value="{{ language }}">
            <input type="hidden" name="level" value="{{ level }}">
            <input type="hidden" name="mode" value="ai">
        </form>
        
        <a href="/" class="back-link">Explain Another Code</a>
    </div>
    <footer>
        Built by Ethan Zhou | <a href="https://github.com/ethanzhoucool/explain-my-code">View on GitHub</a>
    </footer>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        let currentMode = '{{ mode }}';
        let aiLoaded = {{ 'true' if mode == 'ai' else 'false' }};
        let aiContentCache = null;
        
        const ruleBtn = document.getElementById('ruleBtn');
        const aiBtn = document.getElementById('aiBtn');
        const instruction = document.getElementById('instruction');
        
        if (currentMode === 'ai') {
            aiContentCache = document.getElementById('ai-content').innerHTML;
        }
        
        ruleBtn.addEventListener('click', function() {
            if (currentMode === 'rule-based') return;
            
            if (currentMode === 'ai' && !aiContentCache) {
                aiContentCache = document.getElementById('ai-content').innerHTML;
            }
            if (currentMode === 'ai') aiLoaded = true;
            
            document.getElementById('ai-content').style.display = 'none';
            document.getElementById('rule-content').style.display = 'block';
            ruleBtn.classList.add('active');
            aiBtn.classList.remove('active');
            instruction.textContent = 'Hover over highlighted keywords for explanations';
            currentMode = 'rule-based';
            setupRuleTooltips();
        });
        
        aiBtn.addEventListener('click', function() {
            if (currentMode === 'ai') return;
            
            if (aiLoaded && aiContentCache) {
                document.getElementById('ai-content').innerHTML = aiContentCache;
                document.getElementById('ai-content').style.display = 'block';
                document.getElementById('rule-content').style.display = 'none';
                aiBtn.classList.add('active');
                ruleBtn.classList.remove('active');
                instruction.textContent = 'Hover over each line for AI-generated explanations';
                currentMode = 'ai';
                setupAITooltips();
            } else {
                aiBtn.textContent = '...';
                aiBtn.disabled = true;
                aiBtn.classList.add('loading');
                document.getElementById('aiForm').submit();
            }
        });
        
        function setupAITooltips() {
            document.querySelectorAll('#ai-content .ai-line-highlight').forEach(el => {
                if (!el.dataset.tooltipSetup) {
                    setupTooltip(el);
                    el.dataset.tooltipSetup = 'true';
                }
            });
        }
        
        function setupRuleTooltips() {
            document.querySelectorAll('#rule-content .highlight').forEach(el => {
                if (!el.dataset.tooltipSetup) {
                    setupTooltip(el);
                    el.dataset.tooltipSetup = 'true';
                }
            });
        }
        
        // Format markdown-style text in AI summary
        function formatAISummary() {
            const summaryEl = document.getElementById('ai-summary');
            if (!summaryEl) return;
            
            let text = summaryEl.innerHTML;
            
            // Convert **bold** to <strong>
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Convert `code` to <code>
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert lines starting with * to list items
            // First, split by newlines and process
            const lines = text.split('\n');
            let inList = false;
            let result = [];
            
            for (let line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('* ')) {
                    if (!inList) {
                        result.push('<ul class="ai-list">');
                        inList = true;
                    }
                    result.push('<li>' + trimmed.substring(2) + '</li>');
                } else {
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    // Convert → to styled arrow
                    line = line.replace(/→/g, '<span class="arrow">→</span>');
                    // Handle "So this means:" specially
                    if (trimmed.toLowerCase().startsWith('so this means:')) {
                        result.push('<div class="summary-conclusion">' + line + '</div>');
                    } else if (trimmed.startsWith('"') && trimmed.endsWith('"')) {
                        result.push('<blockquote class="summary-quote">' + trimmed.slice(1, -1) + '</blockquote>');
                    } else {
                        result.push(line);
                    }
                }
            }
            if (inList) {
                result.push('</ul>');
            }
            
            summaryEl.innerHTML = result.join('\n');
        }
        
        // Run formatting on page load if in AI mode
        if (currentMode === 'ai') {
            formatAISummary();
        }
    </script>
</body>
</html>