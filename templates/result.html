<!DOCTYPE html>
<html>
<head>
    <title>Code Explanation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Code Explanation</h1>
        
        <div class="badges">
            <span class="level-badge">{{ level|replace('_', ' ')|title }}</span>
            <!-- Toggle switch for mode -->
            <div class="mode-toggle-group">
                <button type="button" class="mode-toggle-btn {% if mode == 'rule-based' %}active{% endif %}" id="ruleBtn">
                    Rule-based
                </button>
                <button type="button" class="mode-toggle-btn {% if mode == 'ai' %}active{% endif %}" id="aiBtn">
                    <span class="btn-text">AI Mode</span>
                    <span class="btn-loading" style="display:none;">‚è≥</span>
                </button>
            </div>
        </div>
        
        <h2>{{ language|title }} Code</h2>
        {% if mode == 'ai' %}
        <p class="instruction">Hover over each line for AI-generated explanations</p>
        {% else %}
        <p class="instruction">Hover over highlighted keywords for explanations</p>
        {% endif %}
        
        <!-- Rule-based content -->
        <div id="rule-content" style="{% if mode == 'ai' %}display:none;{% endif %}">
            <div class="code-container">
                {% for line in rule_annotated_lines %}
                <div class="code-line">
                    <div class="line-number">{{ line.number }}</div>
                    <div class="line-content">{{ line.highlighted|safe }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- AI content (shown or cached) -->
        <div id="ai-content" style="{% if mode != 'ai' %}display:none;{% endif %}">
            {% if mode == 'ai' %}
            <div class="code-container">
                {% for line in annotated_lines %}
                <div class="code-line">
                    <div class="line-number">{{ line.number }}</div>
                    <div class="line-content">{{ line.highlighted|safe }}</div>
                </div>
                {% endfor %}
            </div>
            {% if ai_explanation %}
            <h2>Summary</h2>
            <div class="ai-explanation-box">
                {{ ai_explanation }}
            </div>
            {% endif %}
            {% endif %}
        </div>
        
        <!-- Hidden form for AI request -->
        <form id="aiForm" method="POST" action="/explain" style="display:none;">
            <input type="hidden" name="code" value="{{ code }}">
            <input type="hidden" name="language" value="{{ language }}">
            <input type="hidden" name="level" value="{{ level }}">
            <input type="hidden" name="mode" value="ai">
        </form>
        
        <a href="/" class="back-link">Explain Another Code</a>
    </div>
    <footer>
        Built by Ethan Zhou | <a href="https://github.com/ethanzhoucool/explain-my-code">View on GitHub</a>
    </footer>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Store current mode and AI cache status
        let currentMode = '{{ mode }}';
        let aiLoaded = {% if mode == 'ai' %}true{% else %}false{% endif %};
        let aiContentCache = null;
        
        const ruleBtn = document.getElementById('ruleBtn');
        const aiBtn = document.getElementById('aiBtn');
        const instruction = document.querySelector('.instruction');
        
        {% if mode == 'ai' %}
        // Cache the AI content if we're already in AI mode
        aiContentCache = document.getElementById('ai-content').innerHTML;
        {% endif %}
        
        // Rule-based button click
        ruleBtn.addEventListener('click', function() {
            if (currentMode === 'rule-based') return;
            
            // Cache AI content before switching
            if (currentMode === 'ai' && !aiContentCache) {
                aiContentCache = document.getElementById('ai-content').innerHTML;
            }
            if (currentMode === 'ai') aiLoaded = true;
            
            // Switch views
            document.getElementById('ai-content').style.display = 'none';
            document.getElementById('rule-content').style.display = 'block';
            
            // Update buttons
            ruleBtn.classList.add('active');
            aiBtn.classList.remove('active');
            instruction.textContent = 'Hover over highlighted keywords for explanations';
            
            currentMode = 'rule-based';
            setupRuleTooltips();
        });
        
        // AI button click
        aiBtn.addEventListener('click', function() {
            if (currentMode === 'ai') return;
            
            if (aiLoaded && aiContentCache) {
                // Use cached AI content
                document.getElementById('ai-content').innerHTML = aiContentCache;
                document.getElementById('ai-content').style.display = 'block';
                document.getElementById('rule-content').style.display = 'none';
                
                // Update buttons
                aiBtn.classList.add('active');
                ruleBtn.classList.remove('active');
                instruction.textContent = 'Hover over each line for AI-generated explanations';
                
                currentMode = 'ai';
                setupAITooltips();
            } else {
                // Show loading state and submit form
                const btnText = aiBtn.querySelector('.btn-text');
                const btnLoading = aiBtn.querySelector('.btn-loading');
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                aiBtn.disabled = true;
                aiBtn.classList.add('loading');
                document.getElementById('aiForm').submit();
            }
        });
        
        function setupAITooltips() {
            const aiHighlights = document.querySelectorAll('#ai-content .ai-line-highlight');
            aiHighlights.forEach(highlight => {
                if (!highlight.dataset.tooltipSetup) {
                    setupTooltip(highlight);
                    highlight.dataset.tooltipSetup = 'true';
                }
            });
        }
        
        function setupRuleTooltips() {
            const highlights = document.querySelectorAll('#rule-content .highlight');
            highlights.forEach(highlight => {
                if (!highlight.dataset.tooltipSetup) {
                    setupTooltip(highlight);
                    highlight.dataset.tooltipSetup = 'true';
                }
            });
        }
    </script>
</body>
</html>